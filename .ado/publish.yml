trigger: none
pr: none

parameters:
- name: Build_Type
  type: string
  values:
    - dev
    - rc
    - stable
  default: 'dev'
- name: Patch_Number
  type: number
  default: 0
- name: Deploy_Azure_Quantum_Package
  type: boolean
  default: True
- name: Deploy_QDK_Package
  type: boolean
  default: False

variables:
- name: OwnerPersonalAlias
  value: 'billti'

jobs:
- job: "Build_Azure_Quantum_Python"
  pool:
    vmImage: 'windows-latest'

  steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.11'

    - script: |
        pip install wheel
      displayName: Install wheel

    - script: |
        pip freeze
      displayName: List installed packages

    - script: |
        python set_version.py
      env:
        BUILD_TYPE: ${{ parameters.Build_Type }}
        PATCH_NUMBER: ${{ parameters.Patch_Number }}
      displayName: Set version

    - script: |
        cd $(Build.SourcesDirectory)/azure-quantum
        python setup.py sdist --dist-dir=target/wheels
        python setup.py bdist_wheel --dist-dir=target/wheels
      displayName: Build azure-quantum package

    - publish: $(Build.SourcesDirectory)/azure-quantum/target/wheels/
      artifact: azure-quantum-wheels
      displayName: Upload azure-quantum artifacts

- job: "Test_Azure_Quantum_Python"
  pool:
    vmImage: 'windows-latest'
  
  steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.11'

    - script: |
        pip install pytest pytest-azurepipelines pytest-cov
      displayName: Install pytest dependencies

    - script: |
        pip freeze
      displayName: List installed packages
    
    - script: |
        cd $(Build.SourcesDirectory)/azure-quantum
        pip install .[all]
        pytest --cov-report term --cov=azure.quantum --junitxml test-output-azure-quantum.xml $(Build.SourcesDirectory)/azure-quantum
      displayName: Run azure-quantum unit tests
    
    - task: PublishTestResults@2
      displayName: 'Publish tests results (python)'
      condition: succeededOrFailed()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/test-*.xml'
        testRunTitle: 'Azure Quantum Python Tests'

- job: "Build_QDK_Python"
  pool:
    vmImage: 'windows-latest'

  steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.11'

    - script: |
        pip install wheel
      displayName: Install wheel

    - script: |
        pip freeze
      displayName: List installed packages

    - script: |
        python set_version.py
      env:
        BUILD_TYPE: ${{ parameters.Build_Type }}
        PATCH_NUMBER: ${{ parameters.Patch_Number }}
      displayName: Set version

    - script: |
        cd $(System.DefaultWorkingDirectory)/qdk
        python setup.py sdist --dist-dir=target/wheels
        python setup.py bdist_wheel --dist-dir=target/wheels
      displayName: Build qdk package

    - publish: $(System.DefaultWorkingDirectory)/qdk/target/wheels/
      artifact: qdk-wheels
      displayName: Upload qdk-wheels artifacts

- job: "Approval"
  dependsOn:
  - "Build_Azure_Quantum_Python"
  - "Build_QDK_Python"
  - "Test_Azure_Quantum_Python"
  pool: server
  timeoutInMinutes: 1440 # job times out in 1 day
  steps:
  - task: ManualValidation@0
    timeoutInMinutes: 1440 # task times out in 1 day
    inputs:
      notifyUsers: ''
      instructions: 'Please verify artifacts and approve the release'
      onTimeout: 'reject'

- job: "Publish_Python_Packages"
  dependsOn: Approval
  pool:
    vmImage: 'windows-latest'

  steps:
  - download: current
    artifact: azure-quantum-wheels
    displayName: Download azure-quantum artifacts

  - download: current
    artifact: qdk-wheels
    displayName: Download qdk artifacts

  - script: |
      mkdir -p                            target/wheels
      mv ../azure-quantum-wheels/*.whl    target/wheels
      mv ../qdk-wheels/*.whl              target/wheels
      ls                                  target/wheels/*
    displayName: Move Py Artifacts to Publishing Dir

  - task: CopyFiles@2
    condition: ${{ parameters.Deploy_Azure_Quantum_Package }}
    displayName: Copy azure-quantum artifacts
    inputs:
      SourceFolder: 'azure-quantum-wheels'
      Contents: '**'
      TargetFolder: 'target/wheels'

  - task: CopyFiles@2
    condition: ${{ parameters.Deploy_QDK_Package }}
    displayName: Copy qdk artifacts
    inputs:
      SourceFolder: 'qdk-wheels'
      Contents: '**'
      TargetFolder: 'target/wheels'

  - script: |
      ls target/wheels/*
    displayName: List Py Artifacts to publish

  # - task: EsrpRelease@4
  #   inputs:
  #    ConnectedServiceName: 'ESRP_Release'
  #    Intent: 'PackageDistribution'
  #    ContentType: 'PyPi'
  #    FolderLocation: '$(System.DefaultWorkingDirectory)/target/wheels'
  #    Owners: '$(OwnerPersonalAlias)@microsoft.com'  # NB: Group email here fails the task with non-actionable output.
  #    Approvers: 'billti@microsoft.com'
  #    # Auto-inserted Debugging defaults:
  #    ServiceEndpointUrl: 'https://api.esrp.microsoft.com'
  #    MainPublisher: 'QuantumDevelpmentKit'          # ESRP Team's Correction (including the critical typo "Develpm").
  #    DomainTenantId: '72f988bf-86f1-41af-91ab-2d7cd011db47'
  #   displayName: Publish Py Packages