# Builds react-lib, js-lib and links the packages.
# TO DO: separate builds into separate yaml templates.

resources:
- repo: self
  clean: true

# Trigger whenever a commit occurs in these branches
trigger:
  branches:
      include:
        - main

        #TO DO: remove after publish
        - users/kamcclin/re-visual2
  paths:
    include:
    - visualization

# Trigger whenever a PR is submitted
pr:
  branches:
    include:
      - main
  paths:
    include:
    - visualization

stage: Build Visualization Library
 
variables:
  jslib: js-lib
  rootDirectory: visualization
  project: $(rootDirectory)/react-lib
  reactnodemodules: node-modules/react
  projectname: quantum-visualization
  outputDirectory: $(Agent.BuildDirectory)/output
  tests: $(project)/TestResults

  dependsOn: []
  pool:
    vmImage: 'windows-latest'
  jobs:
  - job: Build

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: "16.x"
    displayName: "Install Node.js"

  # Add later
  # - task: npmAuthenticate@0
  #   inputs:
  #     workingFile: "$(Build.SourcesDirectory)/$(project)/.npmrc"
  #   displayName: "npm authenticate"

  - script: |
      npm install
      npm run build
    workingDirectory: "$(project)"
    displayName: "npm install and build react-lib"

  - script: |
      npm link
    workingDirectory: "$(project)"
    displayName: "npm link react-lib"

  - script: 
      npm link
    workingDirectory: "$(project)/$(reactnodemodules)"
    displayName: "npm link react"

  - script: 
      npm link react $(projectname)
    workingDirectory: "$(rootDirectory)/$(jslib)"
    displayName: "npm link react and quantum visualization to js-lib"

  - script: |
      npm install
      npm run build
    workingDirectory: "$(rootDirectory)/$(jslib)"
    displayName: "npm install and build js-lib"

  - task: Npm@1
    displayName: npm run test
    inputs:
      workingDir: "$(project)"
      command: "custom"
      customCommand: "run tests"

  - task: PublishTestResults@2
    displayName: "publish test results"
    condition: succeededOrFailed() 
    inputs:
      testResultsFiles: "$(tests)/test-results.xml"

  - task: PublishCodeCoverageResults@1
    displayName: "Publish Code Coverage Results"
    inputs:
      codeCoverageTool: "babel"
      summaryFileLocation: "$(project)/coverage/coverage-final.json"

  - task: CopyFiles@2
    inputs:
      SourceFolder: "$(rootDirectory)/$(jslib)/dist"
      Contents: "**"
      TargetFolder: "$(outputDirectory)"
    displayName: "Copy build artifacts to output directory"
