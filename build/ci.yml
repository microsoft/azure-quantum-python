name: $(Build.Major).$(Build.Minor).$(DayOfMonth)$(rev:rr)

trigger:
- main

pr:
- main
- feature/*
- features/*
- release/*

variables:
  Build.Major: 0
  Build.Minor: 1
  Drops.Dir: $(Build.ArtifactStagingDirectory)/drops
  Build.Dotnet.Version: '6.0.302'

schedules:
- cron: "0 9 * * Sat"
  displayName: 'Build for Component Governance'
  branches:
    include:
    - main
  always: true

jobs:
- job: "QDKPython"
  pool: 
    vmImage: 'ubuntu-latest'
  container: mcr.microsoft.com/quantum/linux-selfcontained:latest
  variables:
    CondaPath: '/miniconda/bin'
  strategy:
    matrix:
      qdk:
        PackageName: 'qdk'
        CondaEnvironmentSuffix: ''
      azure-quantum:
        PackageName: 'azure-quantum'
        CondaEnvironmentSuffix: ''
      azure-quantum-cirq-beta:
        PackageName: 'azure-quantum'
        CondaEnvironmentSuffix: '-cirq-beta'
  steps:
  # Since we may be using the Q# container image instead 
  # of a regular build agent image, we may need to install the .NET SDK
  - script: |
      sudo apt-get update
      sudo apt-get install -y dotnet-sdk-6.0
      export DOTNET_ROOT=$HOME/.dotnet
      echo "##vso[task.prependpath]$DOTNET_ROOT"
      echo "##vso[task.prependpath]$DOTNET_ROOT/tools"
    displayName: Install .NET SDK, and update PATH
  # Since we are using the Q# container image instead 
  # of a regular build agent image, we need to install the .NET SDK
  # Note: The UseDotNet@2 does not work and the DotNetCoreInstaller@1 must be used.
  - task: DotNetCoreInstaller@1
    displayName: 'Install .NET SDK $(Build.Dotnet.Version)'
    inputs:
      packageType: sdk
      version:  $(Build.Dotnet.Version)
  - template: steps.yml
    parameters:
      PackageName: $(PackageName)
      CondaEnvironmentSuffix: $(CondaEnvironmentSuffix)
  - task: ms.vss-governance-buildtask.governance-build-task-component-detection.ComponentGovernanceComponentDetection@0
    displayName: 'Component detection'
